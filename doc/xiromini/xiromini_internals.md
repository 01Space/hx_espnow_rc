
# Xiro Xplorer Mini

## Общее описание

6" складной квадрокоптер, управление по Wifi с телефона. Камера FullHD с электронной стабилизацией.
Квадрокоптер летает исключительно в режиме удержания высоты и позиции.
При потере связи происходит автоматический возврат в точку взлета.
Время полета 10-15мин.

Производился до 2019.

Построен на основе Quallcom Flight SDK и ZeroTech SDK. Очень схож с Zerotech Dobby.

Квадрокоптер управляетcя приложением Xiro App. К сожалению, оно не работает на Android 10+. 

Ограничение дальности установлено в 100м, после чего дрон упирается в "виртуальную стену".

Возможно управление приложением FlightGo (выбирать модель квадрокоптера Hesper). Специальные функции не работают (автоматический взлет/посадка, облет по кругу, нет кнопки возврата домой).
Но ограничение дальности увеличено до 420м.

## Сервисы

На квадкоптере запущены ssh, ftp, http. http используется приложением для получения preview видео и фото.

## Подключение по ssh

Пользователь: linaro

Пароль: linaro 


## Обмен данными между телефоном и квадрокоптером

Приложение посылает управляющие пакеты на UDP Port 7078.

Формат пакетов:

0xA0 [Len:byte] [ID:byte] XX XX ... XX  [Sum:byte]


Len - полная длина пакета

Sub - сумма всех байт пакета, кроме самой суммы


Некоторые команды подтверждаются дроном посылкой ответного пакета на порт телефона 7088. 

Формат пакета:

0X0A [Len:byte] XX XX ... XX [Sum:byte]


Дрон посылает видеопоток на порт 7078 телефона.


## FPV видеопоток с квадрокоптера

Приложение инициирует поток видео с порта 6000 квадрокоптера на порт 7078 телефона посылкой пакета вида:

0xa0 0x09 0xe1 0x01 0x51 0x28 0xa6 0x1b 0xc5

в котором 0xa6 0x1b - номер порта 0x1ba6 = 7078, остальные данные не понятны. Для поддержания видеопотока нужно отсылать такие пакеты каждые 3 секунды.

Видеопоток идет в формате h264(? не подтверждено).

Скорость потока ~240-350Кб/сек для потока 320x240. Разрешение потока выбирается в приложении. Битрейт не регулируется динамически (? не подтверждено).

Попытки воспроизвести видеопоток с помощью Videolan не удались:

test.sdp:

c=IN IP4 192.168.4.2

m=video 7078 RTP/AVP 96 

a=rtpmap:96 H264/90000

a=fmtp:96 packetization-mode=1;profile-level-id=42001E  

videolan.exe -i test.sdp

## Пакет каналов управления

Пакет каналов управления имеет формат:

0xA0 0x18 0x01 [Ch1_hi:Byte] [Ch1_lo:Byte]  ... [Ch10_hi:Byte] [Ch10_lo:Byte] [Sum:Byte]

Первые 4 канала - стики AERT. Диапазон 1100...1900.

Канал 5: Headless. 0x3e8(1000) - off, 0x5dc(1500) - on.

Приложение FlightGo посылает 1500, поэтому с ним дрон летает в Headless режиме.

Канал 6: Предположительно RTH(не работает). Xiro app: 0x03e8, Flight Go: 0x00dc 

Канал 7: PTZ Работает только если в канал 6 посылается значение 0x00dc (? не подтверждено). Правое колёсико пульта Xiro Mini.

Канал 8: Фото/Видео (не работает). Левое колёсико пульта Xiro Mini.

Канал 9: Takeoff/Landing (не работает).

Канал 10: Ограничение расстояния. 0x7D0 - 100m, 0x5dc - 420m. Гипотеза: 0x3e8 - 500m.

## Пульт

Для этого квадрокоптера была выпущена ограниченная партия пультов управления, с помощью которых можно летать до 500м с отображением видео и телеметрии на телефоне.
Для использования пульта, в приложении Xiro App необходимо "привязать квадрокоптер к пульту".

Пульт xiro mini - это wifi репитер + пульт, подключенный к репитеру по uart. Формат пакетов по uart совпадает с форматом пакетов на UDP порт 7088, которые посылает приложение.

Дрон сам никуда не соединяется. Он всегда является точкой доступа. "Привязать дрон к пульту" - это заставить пульт (экстендер) соединиться с дроном и "удлинять" его сеть. Телефон соединяется с репитером.

На экстендере пульта есть некий сервис, который позволяет приложению определить, что оно присеодинено к сети пульта.

Пульт Xiro Mini маркируется номером 5810. Пульт Xiro Xplorer V маркируется номером 5800, к Xiro Mini не подходит.


## Получение видео с камер средствами Quallcom Flight SDK

Существет возможность получить изображение с камер с помощью утилиты qcamvid из Quallcom Flight SDK:

Присоединиться по ssh, linaro/linaro

sudo qcamvid -c hires -r 720p -s -t 600

В VideoLan открыть url: rtsp://192.168.1.1:554/fpvview

Смотреть видео с нижней камеры:

sudo qcamvid -c optic -r 720p -s -t 600

Больше опций:

qcamvid -h 

Задержка очень большая.


## Реализация управления квадрокоптером с помощью ESP32

Для управления крадрокоптером нужно присоединмться к его Wifi сети и посылать пакеты каналов управления на UDP Port 7088 20 раз в секунду.
При этом приложение уже не сможет соединиться с квадрокоптером, потому что "Дрон подключен к другому пользователю".

В идеальной реализации управления пультом нужно перехватывать пакеты от приложения на телефоне и подменять пакеты управления.

В существующей реализации ESP32 присоединяется к дрону(192.168.1.1) интерфейсом STA, и создает точку доступа для телефона на интерфейсе AP(192.168.4.1).
Посколько в ESP32 нет роутинга пакетов между интерфейсами, пакеты от приложения не доходят до дрона, и не мешают ESP32 управлять квадрокоптером.
Приложение никак не взаимодействует с дроном. 

Чтобы как-то реализовать просмотр видео, ESP32 пересылает все пакеты телеметрии (STA, порт 7088) и видео(STA, порт 7078) на телефон (AP, 192.168.4.2).

Приложение будет воспринимать эти пакеты, только если уже было соедение в дроном. То есть сначала нужно присоединиться к дрону напрямую,
установить связь, а затем уже включить пульт и переключить телефон на сеть пульта. (Update: видео в приложении отображается, телеметрия нет).
Проверенно только с Xiro App.

Чтобы дрон посылал видеопоток, нужно посылать пакеты 0xa0 0x09 0xe1 ... каждые три секунды.

ESP справляется только с потоком с разрешением 320x240.

Для правильной реализации(с подменой пакетов от приложения) нужно разбираться, как сделан проект ESP32 NAT Router https://github.com/martin-ger/esp32_nat_router
Придется разбираться с библиотекой lwip.

Также есть следующая идея, возможно проще реализуемая:
Телефон подключается к AP 192.168.4.1 Gateway 192.168.4.1 и получает адрес 192.168.4.2. Приложение Xiro App посылает пакеты дрону на адрес 192.168.1.1, которые идут на default gateway 192.6.4.1(ESP32 AP interface).
Но эти пакеты невозможно принять на ESP32(192.168.4.1) на уровне сокетов. Однако, может быть можно включить sniffer callback и разбирать услышанные пакеты.

## О роутинге в ESP32:

ESP32 IP forwarding, bridging, routing

https://esp32.com/viewtopic.php?t=9

## Сборка пульта

Модуль управления квадрокоптером Xiro Mini является частью проекта hx_espnow_rc - внешнего модуля на основе esp32 для авиамодельных пультов.

О сборке модуля: external module for Jumpter T-Lite: https://github.com/RomanLut/hx_espnow_rc/blob/main/doc/transmitter.md

( bluetooth модуль не используется, можно не устанавливать ).





Информация собрана членами сообщества XIRO Drone | DIY в Telegram
